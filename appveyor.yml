#/*============================================================================
#
#  MYPROJECT: A software package for whatever.
#
#  Copyright (c) University College London (UCL). All rights reserved.
#
#  This software is distributed WITHOUT ANY WARRANTY; without even
#  the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
#  PURPOSE.
#
#  See LICENSE.txt in the top level directory for details.
#
#============================================================================*/

version: "{build}"

init:
  - git config --global core.autocrlf input

clone_folder: c:\projects\CMakeCatchTemplate

shallow_clone: false

environment:
  DO_PYTHON_BUILD: "true"
  matrix:
    - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015
      COMPILER: "Visual Studio 14"
      MB_PYTHON: "C:/Python35"
    - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015
      COMPILER: "Visual Studio 14 Win64"
      MB_PYTHON: "C:/Python35-x64"
    - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015
      COMPILER: "Visual Studio 14"
      MB_PYTHON: "C:/Python36"
    - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015
      COMPILER: "Visual Studio 14 Win64"
      MB_PYTHON: "C:/Python36-x64"
    - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
      COMPILER: "Visual Studio 15"
      MB_PYTHON: "C:/Python37"
    - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
      COMPILER: "Visual Studio 15 Win64"
      MB_PYTHON: "C:/Python37-x64"

matrix:
    fast_finish: true
    
configuration:
  - Release

platform:
  - Any CPU

before_build:
- cmd: |
    echo --------------------------------------------------------------------------------
    echo "COMPILER=%COMPILER%, PYTHON=%MB_PYTHON%, CONFIGURATION=%CONFIGURATION%"
    cmake -version
    pwd
    git submodule update -q --init --recursive
    set PATH=%MB_PYTHON%;%PATH%
    echo "PATH=%PATH%"
    echo --------------------------------------------------------------------------------

build_script:
- cmd: |
    echo --------------------------------------------------------------------------------
    echo "Build CMakeCatchTemplate:"
    mkdir build
    cd build
    cmake -G "%COMPILER%" -DBUILD_SUPERBUILD:BOOL=ON -DBUILD_TESTING:BOOL=ON -DBUILD_Boost:BOOL=ON -DBUILD_Python_PyBind:BOOL=OFF -DBUILD_Python_Boost:BOOL=ON -DBUILD_Eigen:BOOL=OFF -DBUILD_glog:BOOL=OFF -DBUILD_gflags:BOOL=OFF -DBUILD_VTK:BOOL=OFF -DBUILD_PCL:BOOL=OFF -DBUILD_OpenCV:BOOL=OFF --config %CONFIGURATION% ..
    cmake --build . --config %CONFIGURATION%
    echo --------------------------------------------------------------------------------
    if %DO_PYTHON_BUILD% == "true" (
      echo "Running python commands"
      "%MB_PYTHON%/python.exe" -m pip install --upgrade pip
      "%MB_PYTHON%/python.exe" -m pip install --upgrade setuptools
      "%MB_PYTHON%/python.exe" -m pip install --user .
      "%MB_PYTHON%/python.exe" setup.py bdist_wheel
      echo "Finished python commands"
    )

after_build:
- ps: |
    echo --------------------------------------------------------------------------------
    cd ${Env:APPVEYOR_BUILD_FOLDER}
    pwd
    if (${Env:DO_PYTHON_BUILD} -eq "true") {
      echo "Running python commands"
      &"${Env:MB_PYTHON}/python.exe" -m pip install --upgrade pip
      &"${Env:MB_PYTHON}/python.exe" -m pip install --upgrade setuptools
      &"${Env:MB_PYTHON}/python.exe" -m pip install --user .
      &"${Env:MB_PYTHON}/python.exe" setup.py bdist_wheel
      echo "Finished python commands"
    }

test_script:
- cmd: |
    echo --------------------------------------------------------------------------------
    pwd
    cd MYPROJECT-build
    pwd
    ctest -C %CONFIGURATION%
    echo --------------------------------------------------------------------------------

deploy_script:
- ps: |
    if (${Env:APPVEYOR_REPO_TAG} -eq "true") {
      if (${Env:DO_PYTHON_BUILD} -eq "true") {
        &"${Env:MB_PYTHON}/python.exe" -m pip install twine
        &"${Env:MB_PYTHON}/python.exe" -m twine upload --repository pypi -u NOT_SET -p NOT_SET --skip-existing dist/*
      }
    }