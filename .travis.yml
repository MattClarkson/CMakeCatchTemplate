#/*============================================================================
#
#  MYPROJECT: A software package for whatever.
#
#  Copyright (c) University College London (UCL). All rights reserved.
#
#  This software is distributed WITHOUT ANY WARRANTY; without even
#  the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
#  PURPOSE.
#
#  See LICENSE.txt in the top level directory for details.
#
#============================================================================*/

# Inspired by: https://github.com/skvark/opencv-python
#        and : https://github.com/matthew-brett/multibuild
# Firstly, we want to compile and test the C++ library of this project on
# Linux and Mac. If you are only doing a C++ library, you can set DO_PYTHON_BUILD
# to false. However, we hope tht lots of people will be inspired to provide
# python wrappers for their C++ libraries, and if they do, building python
# wheels is quite difficult. So, it would be good for this CMakeCatchTemplate
# project to provide the mechanism to enable a C++ Python module to be easily
# deployed. So, that is why we are doing all the Travis/Appveyor
# on an environment that is suitable for BOTH C++ and Python.
# So, we make use of Matthew Brett's multibuild.

env:
  global:
    # Prompt
    - "PS4='+(${BASH_SOURCE}:${LINENO}): ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'"
    - REPO_DIR=.
    - BUILD_COMMIT=HEAD
    - BUILD_DEPENDS="numpy six"
    - TEST_DEPENDS="numpy six"
    - BDIST_PARAMS=""
    - PLAT=x86_64
    - UNICODE_WIDTH=32
    - DO_PYTHON_BUILD="true"

language: python
# The Travis Python version is unrelated to the version we build and test
# with.  This is set with the MB_PYTHON_VERSION variable.
python: 3.5
sudo: required
dist: trusty
services: docker

matrix:
  fast_finish: true
  exclude:
    - python: 3.5
  include:
    # Builds for MacOS
    - os: osx
      language: generic
      osx_image: xcode8
      env:
        - MB_PYTHON_VERSION=2.7
        - BDIST_PARAMS="-- -DCMAKE_OSX_DEPLOYMENT_TARGET:STRING=10.7"
    - os: osx
      language: generic
      osx_image: xcode8
      env:
        - MB_PYTHON_VERSION=3.4
        - BDIST_PARAMS="-- -DCMAKE_OSX_DEPLOYMENT_TARGET:STRING=10.7"
    - os: osx
      language: generic
      osx_image: xcode8
      env:
        - MB_PYTHON_VERSION=3.5
        - BDIST_PARAMS="-- -DCMAKE_OSX_DEPLOYMENT_TARGET:STRING=10.7"
    - os: osx
      language: generic
      osx_image: xcode8
      env:
        - MB_PYTHON_VERSION=3.6
        - BDIST_PARAMS="-- -DCMAKE_OSX_DEPLOYMENT_TARGET:STRING=10.7"
    - os: osx
      language: generic
      osx_image: xcode8
      env:
        - MB_PYTHON_VERSION=3.7
        - BDIST_PARAMS="-- -DCMAKE_OSX_DEPLOYMENT_TARGET:STRING=10.7"
    # Builds for Linux
    - os: linux
      compiler: gcc
      env:
        - MB_PYTHON_VERSION=2.7
    - os: linux
      compiler: gcc
      env:
        - MB_PYTHON_VERSION=2.7
        - UNICODE_WIDTH=16
    - os: linux
      compiler: gcc
      env:
        - MB_PYTHON_VERSION=2.7
        - PLAT=i686
    - os: linux
      compiler: gcc
      env:
        - MB_PYTHON_VERSION=2.7
        - PLAT=i686
        - UNICODE_WIDTH=16
    - os: linux
      compiler: gcc
      env:
        - MB_PYTHON_VERSION=3.3
    - os: linux
      compiler: gcc
      env:
        - MB_PYTHON_VERSION=3.3
        - PLAT=i686
    - os: linux
      compiler: gcc
      env:
        - MB_PYTHON_VERSION=3.4
    - os: linux
      compiler: gcc
      env:
        - MB_PYTHON_VERSION=3.4
        - PLAT=i686
    - os: linux
      compiler: gcc
      env:
        - MB_PYTHON_VERSION=3.5
    - os: linux
      compiler: gcc
      env:
        - MB_PYTHON_VERSION=3.5
        - PLAT=i686
    - os: linux
      compiler: gcc
      env:
        - MB_PYTHON_VERSION=3.6
    - os: linux
      compiler: gcc
      env:
        - MB_PYTHON_VERSION=3.6
        - PLAT=i686
    - os: linux
      compiler: gcc
      env:
        - MB_PYTHON_VERSION=3.7
    - os: linux
      compiler: gcc
      env:
        - MB_PYTHON_VERSION=3.7
        - PLAT=i686

before_install:
    - source multibuild/common_utils.sh
    - source multibuild/travis_steps.sh
    - before_install

install:
    - build_wheel $REPO_DIR $PLAT

script:
    - install_run $PLAT

#before_install: |
#  if [ "$TRAVIS_OS_NAME" = "linux" ]; then
#    sudo apt-get update
    # Note: Most of these were deduced while testing various combinations of VTK, PCL, OpenCV.
    # You may be able to get away with a much smaller list, depending on your actual testing requirements.
#    sudo apt-get -yqq install freeglut3
#    sudo apt-get -yqq install freeglut3-dev
#    sudo apt-get -yqq install binutils-gold
#    sudo apt-get -yqq install libglew-dev
#    sudo apt-get -yqq install mesa-common-dev
#    sudo apt-get -yqq install build-essential
#    sudo apt-get -yqq install libglew1.5-dev
#    sudo apt-get -yqq install libglm-dev
#    sudo apt-get -yqq install mesa-utils-extra
#    sudo apt-get -yqq install libgl1-mesa-dev
#    sudo apt-get -yqq install libglapi-mesa
#  fi
#  if [ "$TRAVIS_OS_NAME" = "osx" ]; then
#    brew update
#    brew install pyenv
#    pyenv install ${PYENV_VERSION}
#    pyenv global ${PYENV_VERSION}
#    eval "$(pyenv init -)"
#    wp=`which python`
#    wpd=`dirname $wp`
#    export PATH=${wpd}:$PATH
#    echo $PATH
#    python --version
#  fi
#
#install: |
#  echo "Working directory is:"
#  pwd
#  echo "PATH is:"
#  echo "$PATH"
#  echo "cmake version is:"
#  cmake --version
#  mkdir build
#  cd build
#  if [ "${PYENV_VERSION}" != "" ]; then
#    cmake_python_string="-DMYPROJECT_PYTHON_VERSION:STRING=${PYENV_VERSION}"
#  fi
#  cmake ${cmake_python_string} -DBUILD_SUPERBUILD:BOOL=ON -DBUILD_TESTING:BOOL=ON -DBUILD_Boost:BOOL=ON -DBUILD_Python_Boost:BOOL=ON -DBUILD_Eigen:BOOL=OFF -DBUILD_glog:BOOL=OFF -DBUILD_gflags:BOOL=OFF -DBUILD_VTK:BOOL=OFF -DBUILD_PCL:BOOL=OFF -DBUILD_OpenCV:BOOL=OFF ..
#  make
#  cd MYPROJECT-build
#  ctest .
#  cd ${TRAVIS_BUILD_DIR}
#  if [ "${DO_PYTHON_BUILD}" = "true" ]; then
#    echo "Running python commands"
#    python -m pip install --upgrade pip
#    python -m pip install --upgrade setuptools
#    python -m pip install --user .
#    python setup.py bdist_wheel
#    echo "Finished python commands"
#  fi
#
#script: |
#    # Build and package
#    set -x
#    build_wheel $REPO_DIR $PLAT
#    if [ -n "$USE_CCACHE" ]; then ccache --show-stats; fi
#    set +x

after_success: |
  # Upload wheels to pypi if requested
  if [ -n "$TRAVIS_TAG" ]; then
    if [ "${DO_PYTHON_BUILD}" = "true"]; then
      set -x
      pip install twine
      if [[ "$TRAVIS_OS_NAME" = "osx" ]]; then
        pip install --upgrade pyOpenSSL
      fi
      twine upload --repository pypi -u NOT_SET -p NOT_SET --skip-existing dist/*
      set +x
    fi
  else
    echo "Tag not set, deployment skipped."
  fi